{% extends "base.html" %}

{% block title %}Отзывы - Школьное питание{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Мои отзывы</h1>
</div>

<div class="row">
    <!-- Форма отзыва -->
    <div class="col-md-5">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Оставить отзыв</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="feedbackForm">
                    {{ form.hidden_tag() }}

                    <div class="mb-3">
                        <label class="form-label fw-bold">Выберите блюдо:</label>
                        <select class="form-select {% if form.meal_id.errors %}is-invalid{% endif %}"
                                name="meal_id" id="meal_id" required>
                            <option value="">-- Выберите блюдо --</option>
                            {% for meal in available_meals %}
                            <option value="{{ meal.id }}"
                                    {% if form.meal_id.data == meal.id %}selected{% endif %}>
                                {{ meal.name }} ({{ meal.meal_type }})
                            </option>
                            {% endfor %}
                        </select>
                        {% if form.meal_id.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.meal_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="text-muted">Выберите блюдо, которое вы пробовали</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Оценка:</label>
                        <div class="rating-container mb-2">
                            <div class="star-rating">
                                {% for i in range(5, 0, -1) %}
                                <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}"
                                       {% if form.rating.data and form.rating.data == i %}checked{% endif %} required>
                                <label for="star{{ i }}" title="{{ i }} звезд">
                                    <i class="bi bi-star{% if form.rating.data and form.rating.data >= i %}-fill text-warning{% endif %}"></i>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% if form.rating.errors %}
                            <div class="text-danger small">
                                {% for error in form.rating.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="rating-labels d-flex justify-content-between mt-1">
                            <small class="text-muted">Плохо</small>
                            <small class="text-muted">Отлично</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Комментарий:</label>
                        <textarea class="form-control {% if form.comment.errors %}is-invalid{% endif %}"
                                  name="comment" id="comment" rows="4"
                                  placeholder="Расскажите о вашем впечатлении: вкус, порция, сервис..."
                                  maxlength="500">{{ form.comment.data or '' }}</textarea>
                        {% if form.comment.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.comment.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">Ваш комментарий поможет улучшить качество питания</small>
                            <small class="text-muted" id="charCount">0/500</small>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-send me-2"></i> Отправить отзыв
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Список отзывов -->
    <div class="col-md-7">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Мои отзывы</h5>
                <span class="badge bg-primary rounded-pill">{{ feedbacks|length }}</span>
            </div>
            <div class="card-body">
                {% if feedbacks %}
                <div class="list-group">
                    {% for feedback in feedbacks %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">{{ feedback.meal_name }}</h6>
                                <span class="badge bg-{% if feedback.meal_type == 'завтрак' %}primary{% else %}success{% endif %} mb-2">
                                    {{ feedback.meal_type }}
                                </span>
                                <div class="rating mb-1">
                                    {% for i in range(1, 6) %}
                                        {% if i <= feedback.rating %}
                                            <i class="bi bi-star-fill text-warning"></i>
                                        {% else %}
                                            <i class="bi bi-star text-secondary"></i>
                                        {% endif %}
                                    {% endfor %}
                                    <span class="text-muted ms-2">({{ feedback.rating }}/5)</span>
                                </div>
                            </div>
                            <div class="text-end">
                                <small class="text-muted d-block">{{ feedback.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                                <small class="text-muted">Автор: {{ feedback.username }}</small>
                                {% if feedback.is_own %}
                                <div class="btn-group btn-group-sm mt-2">
                                    <a href="{{ url_for('edit_feedback', feedback_id=feedback.id) }}"
                                       class="btn btn-outline-primary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <form method="POST" action="{{ url_for('delete_feedback', feedback_id=feedback.id) }}"
                                          style="display: inline;">
                                        {{ form.hidden_tag() if form }}
                                        <button type="submit" class="btn btn-outline-danger"
                                                onclick="return confirm('Вы уверены, что хотите удалить отзыв на блюдо \"{{ feedback.meal_name }}\"?')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        {% if feedback.comment %}
                        <div class="feedback-comment mt-2 p-2 bg-light rounded">
                            <p class="mb-0">{{ feedback.comment }}</p>
                        </div>
                        {% else %}
                        <p class="text-muted mt-2 mb-0"><i>Без комментария</i></p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Статистика -->
                <div class="mt-4 p-3 bg-light rounded">
                    <h6>Статистика ваших отзывов:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Всего отзывов:</span>
                                <strong>{{ feedbacks|length }}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Средняя оценка:</span>
                                <strong>
                                    {% set avg_rating = feedbacks|map(attribute='rating')|sum / feedbacks|length if feedbacks|length > 0 else 0 %}
                                    {{ "%.1f"|format(avg_rating) }}/5
                                </strong>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between mb-2">
                                <span>С комментариями:</span>
                                <strong>{{ feedbacks|selectattr('comment')|list|length }}</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Без комментариев:</span>
                                <strong>{{ feedbacks|rejectattr('comment')|list|length }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-chat-left-text display-4 text-muted mb-3"></i>
                    <h5>У вас пока нет отзывов</h5>
                    <p class="text-muted mb-4">Оставьте свой первый отзыв о блюде, которое вы пробовали!</p>
                    <div class="alert alert-info">
                        <h6><i class="bi bi-lightbulb me-2"></i> Как написать полезный отзыв:</h6>
                        <ul class="mb-0 small text-start">
                            <li>Опишите вкус блюда</li>
                            <li>Укажите размер порции</li>
                            <li>Отметьте свежесть продуктов</li>
                            <li>Сообщите о проблемах, если они были</li>
                            <li>Предложите идеи для улучшения</li>
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
/* Стили для звездного рейтинга */
.star-rating {
    display: inline-block;
    direction: rtl;
    unicode-bidi: bidi-override;
    font-size: 0;
}

.star-rating input {
    display: none;
}

.star-rating label {
    display: inline-block;
    font-size: 2rem;
    padding: 0 5px;
    cursor: pointer;
    color: #ddd;
    transition: color 0.2s;
}

.star-rating label:hover,
.star-rating label:hover ~ label,
.star-rating input:checked ~ label {
    color: #ffc107;
}

.star-rating i {
    transition: all 0.2s;
}

/* Стили для комментариев */
.feedback-comment {
    border-left: 3px solid #0d6efd;
}

.rating-container {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.rating-labels {
    width: 100%;
    padding: 0 10px;
}

/* Анимация при наведении на отзыв */
.list-group-item {
    transition: background-color 0.2s;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}
</style>

<script>
// Подсчет символов в комментарии
document.addEventListener('DOMContentLoaded', function() {
    const commentField = document.getElementById('comment');
    const charCount = document.getElementById('charCount');

    if (commentField && charCount) {
        // Обновляем счетчик при загрузке
        charCount.textContent = commentField.value.length + '/500';

        // Обновляем счетчик при вводе
        commentField.addEventListener('input', function() {
            charCount.textContent = this.value.length + '/500';

            // Подсвечиваем если превышен лимит
            if (this.value.length > 500) {
                charCount.classList.add('text-danger');
                this.classList.add('is-invalid');
            } else {
                charCount.classList.remove('text-danger');
                this.classList.remove('is-invalid');
            }
        });
    }

    // Интерактивные звезды
    const stars = document.querySelectorAll('.star-rating input');
    const starLabels = document.querySelectorAll('.star-rating label i');

    // Инициализация звезд при загрузке
    const selectedStar = document.querySelector('.star-rating input:checked');
    const currentRating = selectedStar ? parseInt(selectedStar.value) : 0;

    starLabels.forEach((icon, i) => {
        const starNumber = 5 - i; // Так как звезды идут в обратном порядке
        if (starNumber <= currentRating) {
            icon.className = 'bi bi-star-fill text-warning';
        }
    });

    stars.forEach((star, index) => {
        star.addEventListener('change', function() {
            const rating = parseInt(this.value);

            // Обновляем иконки звезд
            starLabels.forEach((icon, i) => {
                const starNumber = 5 - i; // Так как звезды идут в обратном порядке
                if (starNumber <= rating) {
                    icon.className = 'bi bi-star-fill text-warning';
                } else {
                    icon.className = 'bi bi-star';
                }
            });
        });

        // Предварительный просмотр при наведении
        star.addEventListener('mouseenter', function() {
            const hoverRating = parseInt(this.value);
            starLabels.forEach((icon, i) => {
                const starNumber = 5 - i;
                if (starNumber <= hoverRating) {
                    icon.className = 'bi bi-star-fill text-warning';
                }
            });
        });

        star.addEventListener('mouseleave', function() {
            const selectedRating = document.querySelector('.star-rating input:checked');
            const currentRating = selectedRating ? parseInt(selectedRating.value) : 0;

            starLabels.forEach((icon, i) => {
                const starNumber = 5 - i;
                if (starNumber <= currentRating) {
                    icon.className = 'bi bi-star-fill text-warning';
                } else {
                    icon.className = 'bi bi-star';
                }
            });
        });
    });

    // Валидация формы
    const feedbackForm = document.getElementById('feedbackForm');
    if (feedbackForm) {
        feedbackForm.addEventListener('submit', function(e) {
            const mealSelect = this.querySelector('#meal_id');
            const ratingInput = this.querySelector('input[name="rating"]:checked');

            let isValid = true;
            let errorMessage = '';

            if (!mealSelect.value) {
                isValid = false;
                errorMessage = 'Пожалуйста, выберите блюдо!';
                mealSelect.focus();
            } else if (!ratingInput) {
                isValid = false;
                errorMessage = 'Пожалуйста, поставьте оценку!';
            } else if (commentField && commentField.value.length > 500) {
                isValid = false;
                errorMessage = 'Комментарий не должен превышать 500 символов!';
                commentField.focus();
            }

            if (!isValid) {
                e.preventDefault();
                alert(errorMessage);
                return false;
            }

            return true;
        });
    }
});
</script>
{% endblock %}