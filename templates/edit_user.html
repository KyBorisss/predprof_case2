{% extends "base.html" %}

{% block title %}Редактирование пользователя - Школьное питание{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Редактирование пользователя: {{ user.username }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('admin_users') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Назад к списку
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Основная информация</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="editUserForm">
                    <div class="mb-3">
                        <label class="form-label">Имя пользователя:</label>
                        <input type="text" class="form-control" name="username" 
                               value="{{ user.username }}" required
                               pattern="[a-zA-Z0-9_]+" minlength="3" maxlength="64"
                               title="Только латинские буквы, цифры и подчеркивание">
                        <small class="text-muted">Латинские буквы, цифры и подчеркивание, 3-64 символа</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email:</label>
                        <input type="email" class="form-control" name="email" 
                               value="{{ user.email }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Роль:</label>
                        <select class="form-select" name="role" required>
                            <option value="ученик" {% if user.role == 'ученик' %}selected{% endif %}>Ученик</option>
                            <option value="повар" {% if user.role == 'повар' %}selected{% endif %}>Повар</option>
                            <option value="администратор" {% if user.role == 'администратор' %}selected{% endif %}>Администратор</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Класс/Группа:</label>
                        <input type="text" class="form-control" name="grade" 
                               value="{{ user.grade or '' }}"
                               maxlength="50">
                        <small class="text-muted">Для учеников - класс, для сотрудников - должность</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Баланс:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="balance" 
                                   value="{{ "%.2f"|format(user.balance) }}"
                                   pattern="\d+(\.\d{1,2})?" step="0.01" min="0">
                            <span class="input-group-text">₽</span>
                        </div>
                        <small class="text-muted">Текущий баланс пользователя</small>
                    </div>

                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Важно!</h6>
                        <p class="mb-0 small">
                            Изменения вступят в силу сразу после сохранения.
                        </p>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Сохранить изменения
                    </button>
                    <a href="{{ url_for('admin_users') }}" class="btn btn-secondary">Отмена</a>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Статистика пользователя</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Заказов всего
                        <span class="badge bg-primary rounded-pill">{{ orders_count }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Отзывов оставлено
                        <span class="badge bg-info rounded-pill">{{ feedbacks_count }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Аллергий указано
                        <span class="badge bg-warning rounded-pill">{{ allergies_count }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Дата регистрации
                        <span class="text-muted">{{ user.created_at.strftime('%d.%m.%Y') }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ID пользователя
                        <code>{{ user.id }}</code>
                    </li>
                </ul>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5>Безопасность</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="bi bi-shield-check"></i> Меры безопасности:</h6>
                    <ul class="mb-0 small">
                        <li>Валидация всех входных данных</li>
                        <li>Проверка уникальности username и email</li>
                        <li>Защита от CSRF (встроена в Flask-WTF)</li>
                        <li>Хеширование паролей</li>
                        <li>Проверка прав доступа</li>
                    </ul>
                </div>
                
                {% if user.id != current_user.id %}
                <div class="alert alert-warning small">
                    <i class="bi bi-exclamation-triangle"></i>
                    Для сброса пароля пользователя обратитесь к системному администратору.
                </div>
                {% else %}
                <a href="{{ url_for('change_password') }}" class="btn btn-warning w-100">
                    <i class="bi bi-key"></i> Изменить мой пароль
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('editUserForm').addEventListener('submit', function(e) {
    const username = this.elements['username'].value;
    const email = this.elements['email'].value;
    const balance = this.elements['balance'].value;

    if (!/^[a-zA-Z0-9_]{3,64}$/.test(username)) {
        alert('Имя пользователя должно содержать только латинские буквы, цифры и подчеркивание (3-64 символа)');
        e.preventDefault();
        return false;
    }

    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        alert('Введите корректный email адрес');
        e.preventDefault();
        return false;
    }

    if (balance && !/^\d+(\.\d{1,2})?$/.test(balance)) {
        alert('Введите корректную сумму баланса (например: 100 или 100.50)');
        e.preventDefault();
        return false;
    }
    
    return true;
});
</script>
{% endblock %}